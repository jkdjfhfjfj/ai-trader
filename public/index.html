<!DOCTYPE html>
<html>
<head>
    <title>Signal Intelligence Dashboard</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        :root { --bg: #0d1117; --card: #161b22; --border: #30363d; --blue: #58a6ff; --green: #3fb950; --red: #f85149; --orange: #f0ad4e; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: #c9d1d9; margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        header { background: var(--card); border-bottom: 1px solid var(--border); padding: 10px 20px; display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; }
        .status-group { display: flex; gap: 15px; align-items: center; }
        .badge { font-size: 11px; padding: 2px 8px; border-radius: 10px; background: #21262d; border: 1px solid var(--border); cursor: help; text-transform: uppercase; font-weight: bold; }
        .online { color: var(--green); border-color: var(--green); }
        .offline { color: var(--red); border-color: var(--red); }
        .recheck-btn { background: var(--blue); color: white; border: none; padding: 5px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; }
        .search-area { padding: 10px 20px; background: var(--bg); flex-shrink: 0; }
        input { width: 100%; background: #010409; border: 1px solid var(--border); color: var(--blue); padding: 12px; border-radius: 6px; box-sizing: border-box; outline: none; }
        main { display: grid; grid-template-columns: 1fr 1fr; gap: 1px; background: var(--border); flex-grow: 1; overflow: hidden; }
        .pane { background: var(--bg); display: flex; flex-direction: column; overflow: hidden; }
        .pane-header { padding: 10px 20px; background: var(--card); border-bottom: 1px solid var(--border); font-weight: bold; font-size: 14px; }
        .feed { overflow-y: auto; padding: 15px; flex-grow: 1; }
        .card { background: var(--card); border: 1px solid var(--border); border-radius: 6px; padding: 12px; margin-bottom: 12px; font-size: 13px; }
        .sig-card { border-left: 4px solid var(--green); }
        .card-meta { display: flex; justify-content: space-between; font-size: 11px; color: #8b949e; margin-bottom: 8px; }
        .sync-tag { color: var(--orange); font-weight: bold; border: 1px solid var(--orange); padding: 0 4px; border-radius: 3px; font-size: 10px; }
        .tp-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-top: 8px; }
        .tp-item { color: var(--green); font-weight: bold; font-family: monospace; }
        .hidden { display: none; }

        #modal { position: fixed; top: 20px; right: 20px; padding: 15px 25px; border-radius: 8px; z-index: 1000; display: none; box-shadow: 0 4px 15px rgba(0,0,0,0.5); animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        .modal-success { background: var(--green); color: white; }
        .modal-error { background: var(--red); color: white; }
    </style>
</head>
<body>
    <div id="modal"></div>

    <header>
        <div style="font-weight: bold; font-size: 18px;">üõ∞Ô∏è Global Bridge</div>
        <div class="status-group">
            <div id="tg-status" class="badge">TG: --</div>
            <div id="ai-status" class="badge">AI: --</div>
            <button class="recheck-btn" onclick="recheck()">üîÑ Recheck</button>
            <div id="clock" style="font-size: 12px; color: #8b949e;">--:--:--</div>
        </div>
    </header>

    <div class="search-area">
        <input type="text" id="filter" placeholder="üîç Search Logs..." onkeyup="doSearch()">
    </div>

    <main>
        <div class="pane">
            <div class="pane-header">üìú ALL LOGS</div>
            <div id="raw-feed" class="feed"></div>
        </div>
        <div class="pane">
            <div class="pane-header" style="color: var(--green)">üéØ VALIDATED SIGNALS</div>
            <div id="signal-feed" class="feed"></div>
        </div>
    </main>

    <script>
        // FIXED: Force polling first then upgrade to WebSocket for Render compatibility
        const socket = io({
            transports: ['polling', 'websocket'],
            upgrade: true
        });

        const seen = new Set();

        function showModal(msg, isError) {
            const m = document.getElementById('modal');
            m.innerText = msg;
            m.className = isError ? 'modal-error' : 'modal-success';
            m.style.display = 'block';
            setTimeout(() => { m.style.display = 'none'; }, 4000);
        }

        // Connection event
        socket.on('connect', () => {
            console.log("‚úÖ Dashboard linked to Bridge");
            showModal("Bridge Link Established", false);
        });

        // FIXED: Update Status Badges
        socket.on('system_status', d => {
            const tg = document.getElementById('tg-status');
            const ai = document.getElementById('ai-status');
            
            tg.innerText = `TG: ${d.tg}`; 
            tg.className = `badge ${d.tg.toLowerCase()}`;
            tg.title = d.tgErr || "Connected";

            ai.innerText = `AI: ${d.ai}`; 
            ai.className = `badge ${d.ai.toLowerCase()}`;
            ai.title = d.aiErr || "Active";

            document.getElementById('clock').innerText = d.time;

            if (d.isManual) {
                const hasError = d.tg === 'OFFLINE' || d.ai === 'OFFLINE';
                const msg = hasError ? `‚ö†Ô∏è Issue: ${d.tgErr || d.aiErr}` : "‚úÖ All Systems Active";
                showModal(msg, hasError);
            }
        });

        // FIXED: Handle incoming signals and logs
        socket.on('new_event', (d) => {
            // Deduplication
            const key = `${d.id}-${d.date}-${d.text.substring(0,15)}`;
            if(seen.has(key)) return; 
            seen.add(key);

            // 1. Create Raw Feed Card
            const r = document.createElement('div');
            r.className = 'card';
            r.setAttribute('data-s', (d.title + d.text + (d.id || '')).toLowerCase());
            
            const analysisText = d.analysis ? `Result: ${d.analysis.is_signal ? 'SIGNAL' : 'IGNORED'}` : 'Processing...';
            
            r.innerHTML = `
                <div class="card-meta">
                    <span style="color:var(--blue); font-weight:bold">${d.title || 'Unknown Channel'}</span>
                    <span>${d.isSync ? '<span class="sync-tag">SYNCED</span> ' : ''}${d.date}</span>
                </div>
                <div>${d.text}</div>
                <div style="font-size:10px; color:#484f58; margin-top:5px;">${analysisText}</div>
            `;
            document.getElementById('raw-feed').prepend(r);

            // 2. Create Signal Card if valid
            if(d.analysis && d.analysis.is_signal) {
                const s = document.createElement('div');
                s.className = 'card sig-card';
                
                // Safety check for TP array
                const tpList = Array.isArray(d.analysis.tp) ? d.analysis.tp : [];
                const tps = tpList.map((t, i) => `<div class="tp-item">TP${i+1}: ${t}</div>`).join('');
                
                s.innerHTML = `
                    <div class="card-meta">
                        <span>CONF: ${d.analysis.confidence || 0}%</span>
                        <span>${d.date}</span>
                    </div>
                    <div style="font-size:16px; font-weight:bold; color:var(--blue); margin-bottom:5px;">
                        ${d.analysis.action} ${d.analysis.pair}
                    </div>
                    <div style="color:var(--red); font-weight:bold">SL: ${d.analysis.sl}</div>
                    <div class="tp-grid">${tps}</div>
                `;
                document.getElementById('signal-feed').prepend(s);
            }
            doSearch();
        });

        function recheck() { 
            socket.emit('manual_recheck'); 
            showModal("Requesting System Recheck...", false);
        }

        function doSearch() {
            const q = document.getElementById('filter').value.toLowerCase();
            document.querySelectorAll('#raw-feed .card').forEach(c => {
                c.classList.toggle('hidden', !c.getAttribute('data-s').includes(q));
            });
        }
    </script>
</body>
</html>
